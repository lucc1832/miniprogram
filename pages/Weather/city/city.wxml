<view class="container">
  <!-- Custom Nav Bar -->
  <view class="custom-nav" style="height: {{navBarHeight}}px; padding-top: {{statusBarHeight}}px;">
    <view class="nav-content" style="height: {{navBarHeight}}px;">
      <!-- Left Action (Back / Cancel) -->
      <view class="nav-left" style="height: {{menuButtonHeight}}px; margin-top: {{menuButtonTop - statusBarHeight}}px;">
        <view class="back-btn" bindtap="back" wx:if="{{!isEditing}}">
          <icon type="waiting" size="20" color="transparent" class="back-arrow"/> <!-- Placeholder icon for alignment or custom SVG -->
          <text class="back-text">返回</text>
        </view>
        <view class="cancel-btn" bindtap="onCancel" wx:if="{{isEditing}}">取消</view>
      </view>

      <!-- Center Title -->
      <view class="nav-title" style="line-height: {{navBarHeight}}px;">
        {{isEditing ? '已选择 ' + selectedCities.length : '城市管理'}}
      </view>
    </view>
  </view>

  <!-- Sub-Header / Toolbar (Search & Edit) -->
  <view class="toolbar" style="margin-top: {{statusBarHeight + navBarHeight}}px;">
    <view class="search-bar" bindtap="onSearch" wx:if="{{!isEditing}}">
      <icon type="search" size="14" color="#999"/>
      <text class="search-text">搜索全球城市</text>
    </view>
    
    <view class="edit-action" bindtap="onToggleEdit" wx:if="{{!isEditing && cities.length > 0}}">
      <text>编辑</text>
    </view>
    <view class="edit-action" bindtap="onSelectAll" wx:if="{{isEditing}}">
      <text>全选</text>
    </view>
  </view>

  <!-- City List -->
  <scroll-view scroll-y class="city-list" style="height: calc(100vh - {{statusBarHeight + navBarHeight + 60}}px);">
    <block wx:for="{{cities}}" wx:key="name">
      <view class="city-card-wrapper {{isEditing ? 'editing-mode' : ''}} fade-in" style="animation-delay: {{index * 0.05}}s">
        
        <!-- Checkbox (Left side in edit mode) -->
        <view class="checkbox-area" bindtap="onSelectCity" data-index="{{index}}" wx:if="{{isEditing}}">
          <view class="checkbox {{utils.includes(selectedCities, index) ? 'checked' : ''}}" wx:if="{{index !== 0}}">
            <icon type="success_no_circle" size="16" color="#fff" wx:if="{{utils.includes(selectedCities, index)}}"/>
          </view>
          <view class="checkbox disabled" wx:else>
             <icon type="info" size="16" color="#ccc" />
          </view>
        </view>

        <!-- Slide Area -->
        <movable-area class="swipe-area">
          <movable-view 
            class="swipe-view" 
            direction="{{(index === 0 || isEditing) ? 'none' : 'horizontal'}}" 
            x="{{item.x}}" 
            data-index="{{index}}"
            bindchange="onSwipeChange"
            bindtouchend="onSwipeEnd"
            damping="40"
            out-of-bounds="true"
            style="width: calc(100% + 160rpx);"
          >
            <!-- Main Content Container -->
            <view class="swipe-content" bindtap="onSelectCity" data-index="{{index}}">
              <!-- Main Card -->
              <view class="city-card">
                <image class="card-bg" src="{{item.bgImage || '/images/default-city-bg.png'}}" mode="aspectFill" wx:if="{{false}}"></image> 
                <view class="card-gradient"></view>
                
                <view class="card-content">
                  <view class="card-left">
                    <view class="city-name-row">
                      <text class="city-name">{{item.name}}</text>
                      <text class="loc-badge" wx:if="{{index === 0}}">当前定位</text>
                    </view>
                    <text class="weather-desc">{{item.condition || '晴'}}</text>
                  </view>
                  
                  <view class="card-right">
                    <text class="temp-text">{{item.temp || '--'}}°</text>
                    <view class="aqi-badge" wx:if="{{item.aqi}}">
                      <text>空气优</text>
                    </view>
                  </view>
                </view>
              </view>
            </view>

            <!-- Delete Button -->
            <view class="slide-delete-btn" catchtap="onSlideDelete" data-index="{{index}}">
              <text>删除</text>
            </view>

          </movable-view>
        </movable-area>

      </view>
    </block>
    
    <!-- Empty State -->
    <view class="empty-state" wx:if="{{cities.length === 0}}">
      <text>暂无城市，请添加</text>
    </view>
    
    <view class="list-footer"></view>
  </scroll-view>

  <!-- Footer Actions (Delete) -->
  <view class="bottom-panel" wx:if="{{isEditing}}">
    <view class="delete-btn {{selectedCities.length > 0 ? 'active' : ''}}" bindtap="onDelete">
      <text>删除 ({{selectedCities.length}})</text>
    </view>
  </view>

  <!-- Floating Add Button -->
  <view class="fab-btn" bindtap="onAddCity" wx:if="{{!isEditing}}">
    <text class="fab-icon">+</text>
  </view>

</view>

<wxs module="utils">
  module.exports.includes = function(arr, item) {
    return arr.indexOf(item) > -1;
  }
</wxs>