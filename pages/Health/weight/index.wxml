<view class="wrap responsive-container">
  <view class="header-row">
    <view class="title-block">
      <view class="title">ä½“é‡ç®¡ç†</view>
      <view class="subtitle">è®°å½•æ¯ä¸€å¤©çš„å˜åŒ–</view>
    </view>
    <view class="header-action">
      <view class="bind-btn" wx:if="{{!isBound}}" bindtap="showBind">
        <text>â• ç»‘å®šæ­å­</text>
      </view>
      <view class="partner-badge" wx:else>
        <text>â¤ï¸ {{partnerName}}</text>
      </view>
    </view>
  </view>

  <!-- Dual Status Card (Only if Bound) -->
  <view class="card dual-card" wx:if="{{isBound}}">
    <view class="dual-row">
      <!-- Me -->
      <view class="dual-user me">
        <view class="u-avatar">æˆ‘</view>
        <view class="u-status">
           <text class="u-tag {{inputDate === today && records.length > 0 && records[records.length-1].date === today ? 'done' : 'todo'}}">
             {{inputDate === today && records.length > 0 && records[records.length-1].date === today ? 'å·²è®°å½•' : 'æœªè®°å½•'}}
           </text>
           <text class="u-streak">è¿ç»­ {{myStreak}} å¤©</text>
        </view>
      </view>
      
      <view class="dual-divider"></view>
      
      <!-- Partner -->
      <view class="dual-user partner">
        <view class="u-avatar p-avatar">TA</view>
        <view class="u-status">
           <text class="u-tag {{partnerTodayStatus === 'recorded' ? 'done' : 'todo'}}">
             {{partnerTodayStatus === 'recorded' ? 'å·²è®°å½•' : 'æœªè®°å½•'}}
           </text>
           <text class="u-streak">è¿ç»­ {{partnerStreak}} å¤©</text>
        </view>
      </view>
    </view>
    
    <!-- Interaction Area -->
    <view class="interaction-area">
      <view class="interaction-msg" wx:if="{{partnerRecord && partnerRecord.change}}">
        TA ä»Šå¤©å˜åŒ–: {{partnerRecord.change > 0 ? '+' : ''}}{{partnerRecord.change}}kg
      </view>
      <view class="interaction-msg" wx:elif="{{partnerTodayStatus === 'recorded'}}">
        TA ä»Šå¤©å·²æ‰“å¡ï¼Œå»é¼“åŠ±ä¸€ä¸‹å§
      </view>
      <view class="interaction-msg" wx:else>
        TA ä»Šå¤©è¿˜æ²¡åŠ¨é™ï¼Œæé†’ä¸€ä¸‹ï¼Ÿ
      </view>
      
      <view class="like-btn {{interaction.likedToday ? 'liked' : ''}}" bindtap="sendLike">
        <text>{{interaction.likedToday ? 'å·²é¼“åŠ± ğŸ‘' : 'ç‚¹èµé¼“åŠ± ğŸ‘'}}</text>
      </view>
    </view>
  </view>

  <!-- Big Current Weight Display -->
  <view class="card current-card">
    <view class="card-label">å½“å‰ä½“é‡ ({{inputDate === today ? 'ä»Šå¤©' : inputDate}})</view>
    <view class="current-weight-row">
      <view class="weight-val">
        <text class="val">{{hideNumbers ? '***' : (records.length > 0 ? records[records.length-1].weight : '--')}}</text>
        <text class="unit">kg</text>
      </view>
      <view class="delta-tag {{lastDelta > 0 ? 'up' : (lastDelta < 0 ? 'down' : '')}}" wx:if="{{records.length >= 2}}">
        <text>{{lastDelta > 0 ? '+' : ''}}{{lastDelta}} kg</text>
      </view>
    </view>
    <view class="tips" wx:if="{{records.length === 0}}">è¿˜æ²¡æœ‰è®°å½•ï¼Œå¼€å§‹ç¬¬ä¸€æ¬¡è®°å½•å§</view>
    <view class="feedback-text" wx:if="{{feedbackText}}">{{feedbackText}}</view>
  </view>

  <!-- Metrics Card -->
  <view class="card metrics-card" bindtap="checkProfile">
    <view class="metrics-header">
      <text class="section-title">èº«ä½“æŒ‡æ ‡</text>
      <text class="edit-profile" catchtap="checkProfile">âš™ï¸</text>
    </view>
    <view class="metrics-row" wx:if="{{bmi > 0}}">
      <view class="metric-item">
        <text class="m-val">{{bmi}}</text>
        <text class="m-label">BMI</text>
      </view>
      <view class="metric-divider"></view>
      <view class="metric-item">
        <text class="m-val">{{bodyFat}}%</text>
        <text class="m-label">ä½“è„‚ç‡</text>
      </view>
    </view>
    <view class="setup-hint" wx:else>
      <text>ç‚¹å‡»å®Œå–„ä¿¡æ¯ï¼ŒæŸ¥çœ‹BMIå’Œä½“è„‚ç‡ ğŸ‘‰</text>
    </view>
  </view>

  <view class="card form-card">
    <view class="section-title">è®°å½•æ–°æ•°æ®</view>
    <view class="form-row">
      <view class="input-group">
        <input class="weight-input" type="digit" placeholder="0.0" value="{{inputWeight}}" bindinput="onWeightInput"/>
        <text class="input-unit">kg</text>
      </view>
      <picker class="date-picker" mode="date" value="{{inputDate}}" start="{{minDate}}" end="{{today}}" bindchange="onDateChange">
        <view class="date-val">{{inputDate}} ğŸ“…</view>
      </picker>
    </view>
    
    <!-- Status Selection -->
    <view class="status-section">
      <view class="status-label">ä»Šæ—¥çŠ¶æ€</view>
      <view class="status-options">
        <view class="status-chip {{selectedStatus===item.val?'active':''}}" 
              wx:for="{{statusOptions}}" wx:key="val" 
              bindtap="onStatusSelect" data-val="{{item.val}}">
          <text>{{item.icon}}</text>
          <text class="chip-label">{{item.label}}</text>
        </view>
      </view>
    </view>

    <button class="save-btn" bindtap="onSaveRecord" disabled="{{saveDisabled}}">
      {{saveDisabled ? 'ä»Šæ—¥å·²è®°å½•' : 'ä¿å­˜è®°å½•'}}
    </button>
  </view>

  <view class="card chart-card">
    <view class="chart-header">
      <view class="section-title">ä½“é‡è¶‹åŠ¿</view>
      <view class="chart-controls">
        <view class="days-toggle">
          <text class="{{trendDays===7?'active':''}}" bindtap="setTrendDays" data-days="7">7å¤©</text>
          <text class="sep">/</text>
          <text class="{{trendDays===30?'active':''}}" bindtap="setTrendDays" data-days="30">30å¤©</text>
        </view>
        <view class="eye-toggle" bindtap="onToggleHideNumbers" style="margin-left: 20rpx;">
          <text>{{hideNumbers ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'}}</text>
        </view>
      </view>
    </view>
    <canvas type="2d" class="chart" id="trendChart" canvas-id="trendChart"></canvas>
  </view>

  <!-- Recent Records List -->
  <view class="card history-card" wx:if="{{records.length > 0}}">
    <view class="section-title">æœ€è¿‘è®°å½•</view>
    <view class="record-list">
      <block wx:for="{{records}}" wx:key="date">
        <!-- Show last 5 records reverse -->
        <view class="record-item" wx:if="{{index >= records.length - 5}}">
          <text class="rec-date">{{item.date}}</text>
          <text class="rec-val">{{hideNumbers ? '***' : item.weight}} kg</text>
        </view>
      </block>
    </view>
  </view>

  <view class="watermark">ä»…ä¾›å‚è€ƒ</view>

  <!-- Profile Modal -->
  <view class="modal-mask" wx:if="{{showProfileModal}}">
    <view class="modal-content">
      <view class="modal-header">å®Œå–„ä¸ªäººä¿¡æ¯</view>
      <view class="modal-body">
        <view class="form-item">
          <text class="f-label">èº«é«˜ (cm)</text>
          <input class="f-input" type="number" placeholder="170" value="{{tempProfile.height}}" bindinput="onProfileInput" data-field="height"/>
        </view>
        <view class="form-item">
          <text class="f-label">å‡ºç”Ÿå¹´ä»½</text>
          <input class="f-input" type="number" placeholder="1990" value="{{tempProfile.birthYear}}" bindinput="onProfileInput" data-field="birthYear"/>
        </view>
        <view class="form-item">
          <text class="f-label">æ€§åˆ«</text>
          <radio-group class="f-radio-group" bindchange="onProfileInput" data-field="gender">
            <label class="radio-label"><radio value="1" checked="{{tempProfile.gender==1}}"/>ç”·</label>
            <label class="radio-label"><radio value="0" checked="{{tempProfile.gender==0}}"/>å¥³</label>
          </radio-group>
        </view>
      </view>
      <button class="save-profile-btn" bindtap="onSaveProfile">ä¿å­˜å¹¶è®¡ç®—</button>
    </view>
  </view>

  <!-- Bind Modal -->
  <view class="modal-mask" wx:if="{{showBindModal}}">
    <view class="modal-content">
      <view class="modal-header">ç»‘å®šä½“é‡æ­å­</view>
      <view class="modal-body">
        <view class="invite-section">
          <text class="invite-label">æˆ‘çš„é‚€è¯·ç </text>
          <view class="invite-code-box" bindtap="copyInviteCode">
            <text class="code-text">{{inviteCode}}</text>
            <text class="copy-hint">ç‚¹å‡»å¤åˆ¶</text>
          </view>
        </view>
        <view class="bind-divider">æˆ–è€…</view>
        <view class="form-item">
          <text class="f-label">è¾“å…¥å¯¹æ–¹é‚€è¯·ç </text>
          <input class="f-input" type="text" placeholder="è¯·è¾“å…¥é‚€è¯·ç " value="{{bindInput}}" bindinput="onBindInput"/>
        </view>
      </view>
      <view class="modal-actions">
        <button class="cancel-btn" bindtap="hideBind">å–æ¶ˆ</button>
        <button class="confirm-btn" bindtap="confirmBind">ç¡®è®¤ç»‘å®š</button>
      </view>
    </view>
  </view>
</view>
